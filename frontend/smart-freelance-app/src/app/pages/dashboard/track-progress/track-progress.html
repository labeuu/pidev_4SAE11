<div class="track-progress-page">
  <h1>Track progress</h1>
  <p class="subtitle">Select a project to view freelancer progress updates and add or manage your comments.</p>

  @if (errorMessage) {
    <div class="error-banner" role="alert">{{ errorMessage }}</div>
  }

  @if (currentUser && (stats || statsLoading)) {
    <section class="stats-section">
      <app-card class="stats-card">
        <h2 class="stats-title">Your progress at a glance</h2>
        @if (statsLoading && !stats) {
          <p class="stats-loading">Loading statistics‚Ä¶</p>
        } @else if (stats) {
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-value">{{ stats.totalProjects }}</span>
              <span class="stat-label">Total projects</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ stats.totalUpdates }}</span>
              <span class="stat-label">Updates received</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ stats.totalComments }}</span>
              <span class="stat-label">Comments</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ stats.averageProgressPercentage != null ? (stats.averageProgressPercentage | number:'1.1-1') + '%' : '‚Äî' }}</span>
              <span class="stat-label">Avg. progress</span>
            </div>
          </div>
        }
      </app-card>
    </section>
  }

  @if (selectedProject) {
    <app-card>
      <div class="project-header">
        <button type="button" class="btn-back" (click)="backToProjects()">‚Üê Back to my projects</button>
        <h2 class="project-title">{{ selectedProject.title }}</h2>
        @if (selectedProject.description) {
          <p class="project-desc">{{ selectedProject.description }}</p>
        }
      </div>

      <div class="toolbar-filters" [formGroup]="filterForm">
        <input
          type="text"
          formControlName="search"
          (input)="onSearchChange()"
          class="search-input"
          placeholder="Search by title or description‚Ä¶"
          aria-label="Search progress updates"
        />
        <button type="button" class="btn-clear" (click)="clearSearch()" [disabled]="loadingUpdates">Clear</button>
      </div>

      <div class="toolbar">
        <span class="count">{{ totalElements }} update(s) ¬∑ Page {{ page + 1 }} of {{ totalPages || 1 }}</span>
      </div>

      @if (loadingUpdates) {
        <p class="loading-msg">Loading progress updates‚Ä¶</p>
      } @else if (updates.length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üìä</span>
          <p>No progress updates for this project yet. Updates will appear here when your freelancer submits progress.</p>
        </div>
      } @else {
        <div class="updates-list">
          @for (u of updates; track u.id) {
            <div class="update-card">
              <div class="update-main">
                <div class="update-header">
                  <h3>{{ u.title }}</h3>
                  <div class="progress-display">
                    <div class="progress-display__bar" role="presentation">
                      <span class="progress-display__fill" [style.width.%]="u.progressPercentage"></span>
                    </div>
                    <span class="progress-display__pct">{{ u.progressPercentage }}%</span>
                  </div>
                </div>
                @if (u.description) {
                  <p class="update-desc">{{ u.description }}</p>
                }
                <p class="update-meta">Freelancer ID: {{ u.freelancerId }} ¬∑ Updated {{ formatDate(u.updatedAt) }}</p>
              </div>
              <div class="comments-block">
                <h4>Your feedback ({{ (commentsByUpdateId[u.id] || []).length }})</h4>
                @if (loadingComments[u.id]) {
                  <p class="loading-comments">Loading comments‚Ä¶</p>
                } @else {
                  @for (comment of commentsByUpdateId[u.id] || []; track comment.id) {
                    <div class="comment">
                      <p class="comment-text">{{ comment.message }}</p>
                      <span class="comment-meta">{{ formatDate(comment.createdAt) }}</span>
                      @if (isMyComment(comment)) {
                        <div class="comment-actions">
                          <button type="button" class="btn-edit" (click)="openEditComment(comment)">Edit</button>
                          <button type="button" class="btn-delete" (click)="confirmDeleteComment(comment)">Delete</button>
                        </div>
                      }
                    </div>
                  }
                  <button type="button" class="btn-add-comment" (click)="openAddComment(u.id)">Add comment</button>
                }

                @if (addCommentForUpdateId === u.id) {
                  <div class="add-comment-form">
                    <form [formGroup]="addCommentForm" (ngSubmit)="submitComment()">
                      <label for="add-message">Your comment <span class="required">*</span></label>
                      <textarea id="add-message" formControlName="message" [maxlength]="messageMax" rows="3" placeholder="Share feedback for the freelancer‚Ä¶"></textarea>
                      @if (getAddMessageError()) {
                        <span class="field-error">{{ getAddMessageError() }}</span>
                      }
                      <span class="char-count">{{ addCommentForm.get('message')?.value?.length ?? 0 }}/{{ messageMax }}</span>
                      <div class="form-actions">
                        <button type="button" (click)="cancelAddComment()">Cancel</button>
                        <button type="submit" [disabled]="addCommentForm.invalid || saving">{{ saving ? 'Saving‚Ä¶' : 'Post' }}</button>
                      </div>
                    </form>
                  </div>
                }

                @if (isEditingCommentInUpdate(u.id)) {
                  <div class="edit-comment-form">
                    <form [formGroup]="editCommentForm" (ngSubmit)="saveEditComment()">
                      <label for="edit-message">Edit comment <span class="required">*</span></label>
                      <textarea id="edit-message" formControlName="message" [maxlength]="messageMax" rows="3"></textarea>
                      @if (getEditMessageError()) {
                        <span class="field-error">{{ getEditMessageError() }}</span>
                      }
                      <span class="char-count">{{ editCommentForm.get('message')?.value?.length ?? 0 }}/{{ messageMax }}</span>
                      <div class="form-actions">
                        <button type="button" (click)="cancelEditComment()">Cancel</button>
                        <button type="submit" [disabled]="editCommentForm.invalid || saving">{{ saving ? 'Saving‚Ä¶' : 'Save' }}</button>
                      </div>
                    </form>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
      @if (totalPages > 1) {
        <nav class="pagination" aria-label="Progress updates pagination">
          <button type="button" class="btn-page" (click)="goToPage(0)" [disabled]="page === 0 || loadingUpdates">First</button>
          <button type="button" class="btn-page" (click)="goToPage(page - 1)" [disabled]="page === 0 || loadingUpdates">Prev</button>
          <span class="pagination-info">Page {{ page + 1 }} of {{ totalPages }}</span>
          <button type="button" class="btn-page" (click)="goToPage(page + 1)" [disabled]="page >= totalPages - 1 || loadingUpdates">Next</button>
          <button type="button" class="btn-page" (click)="goToPage(totalPages - 1)" [disabled]="page >= totalPages - 1 || loadingUpdates">Last</button>
        </nav>
      }
    </app-card>
  } @else {
    <app-card>
      @if (loading) {
        <p class="loading-msg">Loading your projects‚Ä¶</p>
      } @else if (projects.length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üóÇÔ∏è</span>
          <p>You have no projects yet. Post a job to create projects and receive progress updates.</p>
        </div>
      } @else {
        <div class="toolbar-filters toolbar-filters--projects" [formGroup]="projectFilterForm">
          <input
            type="text"
            formControlName="search"
            class="search-input"
            placeholder="Search projects by title, description or ID‚Ä¶"
            aria-label="Search projects"
          />
          <button type="button" class="btn-clear" (click)="clearProjectSearch()">Clear</button>
        </div>
        <p class="section-label">Select a project to view progress and leave comments</p>
        <div class="toolbar toolbar--projects">
          <span class="count">{{ filteredProjects.length }} project(s)</span>
        </div>
        @if (filteredProjects.length === 0) {
          <p class="empty-msg">No projects match your search. Try a different term or clear the search.</p>
        } @else {
          <div class="projects-grid">
            @for (project of filteredProjects; track project.id) {
              <button type="button" class="project-card" (click)="selectProject(project)">
                <span class="project-card-title">{{ project.title }}</span>
                @if (project.description) {
                  <span class="project-card-desc">{{ project.description }}</span>
                }
                <span class="project-card-meta">Project #{{ project.id }}</span>
              </button>
            }
          </div>
        }
      }
    </app-card>
  }

  @if (deleteCommentTarget) {
    <div class="modal-backdrop" (click)="cancelDeleteComment()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h2>Delete comment?</h2>
        <p>This comment will be removed.</p>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="cancelDeleteComment()">Cancel</button>
          <button type="button" class="btn-delete" (click)="doDeleteComment()" [disabled]="deleting">
            {{ deleting ? 'Deleting‚Ä¶' : 'Delete' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
